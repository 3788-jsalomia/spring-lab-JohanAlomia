name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    env:
      RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
      RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}

    steps:
      - name: Mostrar versi칩n
        run: echo "APP_VERSION=${GITHUB_SHA}" >> $GITHUB_ENV

      - name: Ejecutar deploy a Render
        id: deploy_render
        run: |
          echo "Ejecutando hook de Render..."
          HTTP_CODE=$(curl -s -o output.json -w "%{http_code}" "$RENDER_DEPLOY_HOOK")
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          cat output.json
        continue-on-error: false

      - name: Validar deploy
        id: validar
        run: |
          if [ "${{ steps.deploy_render.outputs.http_code }}" != "200" ]; then
            echo "Deploy fall칩"
            exit 1
          fi
          echo "Deploy exitoso"

      - name: Ejecutar rollback si fall칩 el deploy
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            console.log("Ejecutando rollback autom치tico...");
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "rollback.yml",
              ref: "main"
            });
